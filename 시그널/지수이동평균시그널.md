# 패키지 설치
```
!pip install pykrx
!pip install pandas_ta

```

# 데이터 수집
```python
from pykrx import stock

df = stock.get_market_ohlcv_by_date(fromdate="20200101", todate="20220728", ticker="005930")
df = df.reset_index()

df.columns = ["time", "Open", "High", "Low", "Close", "Volume"]
df = df[df["Volume"] != 0]

```

# 수집 데이터 가공
```python
import pandas_ta as ta

df["EMA"] = ta.ema(df.Close, length=200)
df["ATR"]= df.ta.atr()

df.dropna(inplace=True)
df.reset_index(inplace=True)

```


# 지수이동평균 시그널
```python
# 일별 ema 시그널 저장
emasignal = [0] * len(df)

# 현재가와 비교할 과거 주가들(기간: 일)
# 과거 4일전 주가와 비교, 변경 가능
backcandles = 4 

for row in range(backcandles, len(df)):
    upt = 1 # 상승
    dnt = 1 # 하락
    for i in range(row - backcandles, row + 1):
        # 당일 고가가 지수 이동평균 가격보다 높으면, 하락 추세 아님
        if df.High[i] >= df.EMA[i]:
            dnt = 0

        # 지수이동평균 가격이 당일 저가 보다 높으면, 상승 추세 아님
        if df.Low[i] <= df.EMA[i]:
            upt = 0

    if upt == 1 and dnt == 1:
        print("!!!!! check trend loop !!!!")
        emasignal[row] = 3 # 상승, 하락 아님. 횡보 ???
    elif upt == 1:
        emasignal[row] = 2 # 상승, 매수 시그널
    elif dnt == 1:
        emasignal[row] = 1  # 하락, 매도 시그널

df["EMASignal"] = emasignal

```

# 거래량 시그널
```python
# 금일 거래량과 지난 3일간의 거래량 증가여부를 매매 시그널로 사용
VSignal = [0] * len(df)
# 전일 거래량과 비교
vbackcandles = 1

for row in range(vbackcandles + 1, len(df)):
    # 매수 시그널 기본값 설정
    VSignal[row] = 1
    for i in range(row - vbackcandles, row):
        # row: 오늘 거래량
        # i: 전일 거래량
        # 3일간 거래량이 줄었다면
        if (df.Volume[row] < df.Volume[i]) and (df.Volume[row - 1] < df.Volume[row - 2]):
            VSignal[row] = 0

df["VSignal"] = VSignal

df.dropna(inplace=True)
df.reset_index(drop=True, inplace=True)

```

# 가격 시그널
```python
PriceSignal = [0] * len(df)
# 과거 4일간의 캔들 비교
pbackcandles = 4

for row in range(pbackcandles, len(df)):
    PriceSignal[row] = 1
    for i in range(row - pbackcandles, row):
        if df.EMASignal[row] == 1: # downtrend
            if df.Open[row] <= df.Close[row]: # downcandle row
                PriceSignal[row] = 0
            elif df.Open[i] > df.Close[i]: # downcandle i we are looking for 4 upcandles
                PriceSignal[row] = 0
        if df.EMASignal[row] == 2: # uptrend
            if df.Open[row] >= df.Close[row]: # upcandle row
                PriceSignal[row] = 0
            elif df.Open[i] < df.Close[i]: # upcandle i we are looking for 4 dowcandles
                PriceSignal[row] = 0
        else:
            PriceSignal[row] = 0

df["PriceSignal"] = PriceSignal

df.dropna(inplace = True)
df.reset_index(drop = True, inplace = True)

```

# 전체 시그널
```python
TotSignal = [0] * len(df)
for row in range(0, len(df)):
    if df.EMASignal[row] == 1 and df.VSignal[row] == 1 and df.PriceSignal[row] == 1:
        TotSignal[row] = 1
    if df.EMASignal[row] == 2 and df.VSignal[row] == 1 and df.PriceSignal[row] == 1:
        TotSignal[row] = 2

df["TotSignal"] = TotSignal

df.dropna(inplace = True)
df.reset_index(drop = True, inplace = True)

```

# 시각화
```python
import numpy as np

def pointpos(x):
    if x["TotSignal"] == 1:
        return x["High"] + 2e-3
    elif x["TotSignal"] == 2:
        return x["Low"] - 2e-3
    else:
        return np.nan

df["pointpos"] = df.apply(lambda row: pointpos(row), axis = 1)

```

```python
import plotly.graph_objects as go
from plotly.subplots import make_subplots
from datetime import datetime

dfpl = df

fig = go.Figure(data=[go.Candlestick(x=dfpl.index,
                open=dfpl["Open"],
                high=dfpl["High"],
                low=dfpl["Low"],
                close=dfpl["Close"]),
                go.Scatter(x=dfpl.index, y=dfpl.EMA, line=dict(color="red", width=1), name="EMA")])

fig.add_scatter(x=dfpl.index, y=dfpl["pointpos"], mode="markers",
                marker=dict(size=8, color="MediumPurple"),
                name="Signal")
fig.show()

```

![image](https://user-images.githubusercontent.com/102650331/181469755-87d19035-0f3a-4168-9509-13fac70de609.png)

