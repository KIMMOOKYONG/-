```
!pip install pint
!pip install modsimpy
!pip install yfinance

```

```python
from modsim import *
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import yfinance as yf

```

```python
#----------------------------
# function that will create a dataframe for a single stock
# create_stock_df("GOOG", "2022-01-01", "2022-12-31", 20)
#----------------------------
def create_stock_df(stock, start, end, SMA):

    df = yf.download(stock, start = start, end = end, progress = False)

    df["day"] = range(1, len(df) + 1) # +1을하는 이유는 시작번호가 1로 시작하기 때문이다.
    df["stock"] = stock
    df["SMA_x"] = df.iloc[:,4].rolling(window=SMA).mean()
    df["shifted_close"] = df["Close"].shift(1)
    df["close_difference"] = df["Close"] - df["shifted_close"]
    df = df.reset_index()

    return df

```
![image](https://user-images.githubusercontent.com/102650331/186828637-1bc7b7ea-4af9-41fc-bfd4-79e80595aa2e.png)

```python
#----------------------------
# function to plot the stock dataframe's closing prices
# plot_stock_price(df)
#----------------------------
def plot_stock_price(df):
    x = df["Date"]
    y = df["Close"]
    plt.plot(x, y)

    plt.xlabel("date")
    plt.ylabel("price/share")
    plt.xticks(rotation=70)
    plt.title("stock price over time")
    plt.show()

```
![image](https://user-images.githubusercontent.com/102650331/186828695-90612b18-59a9-401a-8003-c481686a911d.png)

```python
#----------------------------
# create a function that defines a state object
# for financial information that will change during simulation
# input your:
# 1. total dollars to invest
# 2. your entry signal in days
# 3. your exit signal (based on N, i.e. .5N)
# create_state_object(5_000_000, 55, 1)
#----------------------------
def create_state_object(dollars, entry, exit):
    return State(
        dollars = dollars,
        share = 0,
        total_value = dollars,
        x_day_high = 0,
        x_day_low = 0,
        current_price = 0,
        ATR = 0,
        SMA_x = 0,
        x = entry,
        exit_x = exit,
        status = "out",
        entry_price = 0,
        exit_price = 0
    )

```
![image](https://user-images.githubusercontent.com/102650331/186829513-83eff2e4-f2dd-4987-8dce-09f5cdee73f1.png)

```python
#----------------------------
# function that will create a system of parameters (that will not change during simulation)
# make_system(df, state, 5_000_000, 0.1, 0.5)
#----------------------------
def make_system(df, state, starting_dollars, unit_size, add_unit_signal):
    return System(
        t_0 = get_first_label(df),
        t_end = get_last_label(df),
        starting_dollars = starting_dollars,
        unit_size = starting_dollars * unit_size,
        add_unit_signal = add_unit_signal,
        entry_signal = state.x,
        exit_signal = state.exit_x,
        stock = get_first_value(df["stock"]),
        financials = state
    )

```
![image](https://user-images.githubusercontent.com/102650331/186850770-17bd924c-d1bf-48e8-8538-392a3a375e11.png)

```python
#----------------------------
# The update function takes the state during the current time step
# and returns the state during the next time step.
# update_func(df, state, 105, system)
#----------------------------
def update_func(df, state, t, system):
    dollars = state.dollars
    shares = state.shares
    x = state.x
    exit_x = state.exit_x
    status = state.status
    entry_price = state.entry_price
    exit_price = state.exit_price
    add_unit_signal = system.add_unit_signal

    # 55일 이전 데이터를 데이터프레임에서 삭제를 하면 필요없는 코드이다.
    if t <= x + 2:
        xdh = max(df["Close"][1:x])
        xdl = min(df["Close"][1:x])
        sma_x = df["SMA_x"][t]
        atr = (xdh - xdl) / 1.5
        current_price = df["Close"][t]

    if t > x + 2:
        xdh = max(df["Close"][t-x:t+1])
        xdl = min(df["Close"][t-x:t+1])
        sma_x = df["SMA_x"][t]
        atr = (xdh - xdl) / 1.5
        current_price = df["Close"][t]

        # 매수 시그널 발생, status(포지션)가 out 이면
        if current_price  >= xdh and status == "out":
            entry_price = current_price
            shares = system.unit_size // entry_price
            dollars = dollars - (system.unit_size // entry_price) * entry_price
            status = "in"
        # 추가 매수 시그널 발생, status(포지션)가 in 이면
        elif (status == "in") and (current_price > (entry_price + (atr * add_unit_signal))) and (dollars > current_price):
            entry_price = current_price
            shares = system.unit_size // entry_price
            dollars = dollars - (system.unit_size // entry_price) * entry_price
            status = "in"
        elif (current_price < (sma_x - (atr * exit_x))) and (status == "in"):
            entry_price = current_price
            shares = 0
            dollars = dollars + (shares * exit_price)
            status = "out"
        else:
            entry_price = entry_price
            exit_price = exit_price
            shares = shares
            dollars = dollars

    return State(
        dollars = dollars,
        share = shares,
        total_value = dollars + (shares * current_price),
        x_day_high = xdh,
        x_day_low = xdl,
        current_price = current_price,
        ATR = atr,
        SMA_x = sma_x,
        x = x,
        exit_x = exit_x,
        status = status,
        entry_price = entry_price,
        exit_price = exit_price
    )

```
![image](https://user-images.githubusercontent.com/102650331/186867159-8f8697de-0aaf-4561-84fd-5d07b1637aaa.png)

```python
#----------------------------
# define run simulation function that stores results in a TimeFrame
#----------------------------
def run_simulation(df, system, update_func):
    frame = TimeFrame(columns=system.financials.index)
    frame.row[system.t_0] = system.financials

    for t in linrange(system.t_0, system.t_end):
        frame.row[t+1] = update_func(df, frame.row[t], t, system)

    return frame

```
![image](https://user-images.githubusercontent.com/102650331/186871445-0cd13fe4-82dc-4291-927b-51deb56d5586.png)

