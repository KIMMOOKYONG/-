# ë²„í‚· ì •ì±…
- ë²„í‚·ì„ ì‚¬ìš©í•  ê¶Œí•œì„ ê°€ì§„ ì—¬ëŸ¬ ëª…ì˜ ì‚¬ìš©ì ë³„ë¡œ ê°ê°ì˜ í–‰ìœ„ì— ëŒ€í•œ ê¶Œí•œ ë²”ìœ„ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.
- ëˆ„êµ°ê°€ëŠ” ì½ê¸°ë§Œ ê°€ëŠ¥í•˜ê³  ëˆ„êµ°ê°€ëŠ” ì½ê¸°, ì“°ê¸° ëª¨ë‘ ê°€ëŠ¥í•œ ìƒíƒœë¡œë„ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.
- ì„¤ì •ì€ Bucket Policyë¥¼ í†µí•´ ì„¤ì •í•œë‹¤.
- ê¶Œí•œì„ ë³€ê²½í•˜ê³  ì‹¶ì€ ë²„í‚·ì„ ë“¤ì–´ê°€ ê¶Œí•œì„ í´ë¦­í•œë‹¤.
- ì •ì±… ìƒì„±ê¸°ë¥¼ í´ë¦­í•œë‹¤.
- ê° ì„¤ì •ì„ ì„ íƒí•œ í›„ Add Statementë¥¼ í´ë¦­í•œë‹¤.
- Generate Policyë¥¼ ëˆ„ë¥¸ í›„ ë‚˜ì˜¨ ì½”ë“œë¥¼ ë³µì‚¬í•˜ì—¬ ë²„í‚· ì •ì±… ë¶€ë¶„ì— ë¶™ì—¬ ë„£ê³  ë³€ê²½ì‚¬í•­ ì €ì¥í•œë‹¤.

# S3 (Simple Storage Service) ì ìš© ì‚¬ë¡€
- ì •ì  ì‚¬ì´íŠ¸ ì œê³µ
- íŒŒì¼ì„œë²„
- ë°°í¬ íŒŒì¼ ê´€ë¦¬

# S3 ê¶Œí•œê´€ë¦¬
- Public Access(ë¶ˆíŠ¹ì • ë‹¤ìˆ˜ì—ê²Œ ì ‘ê·¼ ê¶Œí•œ í—ˆìš© ì—¬ë¶€, ì •ì  ì›¹ ì‚¬ì´íŠ¸ ê¸°ëŠ¥)
- ACL(ì‚¬ìš©ì, ë²„í‚·, ê°ì²´)
- Bucket Policy
    - Action
        - S3:getObject;(ì½ê¸°)
        - s3:putObejct;(ì“°ê¸°)
    - Effect
        - í—ˆë½(allow)
        - ê±°ë¶€(deny)
    - Resource
        - ResourceëŠ” ëŒ€ìƒì´ ëŒ€ëŠ” Bucketì— ëŒ€í•œ ëª…ì„¸ë¥¼ ì§„í–‰
    - Principal
            - íŠ¹ì • ì‚¬ìš©ìì— ëŒ€í•´ ëª…ì„¸
            - { "AWS": "arn:aws:iam::Account-ID:user/Dave"}

# S3 ë²„í‚·/ê°ì²´ ê°œë…
- S3ì—ëŠ”Â Bucketê³¼Â Objectë¼ëŠ” ë‹¨ìœ„ê°€ ìˆë‹¤.
- ê°ì²´(Object)ëŠ” ë°ì´í„°ì™€ ë©”íƒ€ë°ì´í„°ë¥¼ êµ¬ì„±í•˜ê³  ìˆëŠ” ì €ì¥ ë‹¨ìœ„
- ë²„í‚·(Bucket)ì€ ì´ëŸ¬í•œ ê°ì²´ë¥¼ ì €ì¥í•˜ê³  ê´€ë¦¬í•˜ëŠ” ì—­í• ì„ í•œë‹¤.

# Bucket PolicyëŠ” JSON í˜•ì‹ìœ¼ë¡œ ì´ë£¨ì–´ì ¸ ìˆë‹¤.
```javascript
{
    "Version": "2012-10-17", // Bucket Policyì˜ ë¬¸ë²•ì´ ì–¸ì œ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ í™•ì •ëœ ë¬¸ë²•ì„ ì‚¬ìš©í•˜ëŠ”ì§€ > 2008-10-17 ë²„ì „ í›„ 2012-10-17 ë²„ì „ì´ ìˆëŠ”ë°, ê·¸ ë’¤ë¡œëŠ” ì—…ë°ì´íŠ¸ê°€ ì•ˆëìŒ
    "Id": "S3PolicyId1", // Bucket Policyì˜ ê³ ìœ  ì•„ì´ë””, ìë™ìœ¼ë¡œ ë¶€ì—¬ë˜ëŠ” ê²½ìš°ê°€ ë§ìŒ
    "Statement": [
        {
            "Sid": "IPAllow", // ê° Statementì˜ ê³ ìœ  ì•„ì´ë””. ë¬´ìŠ¨ ì—­í• ì„ í•˜ëŠ” policyì¸ê°€
            "Effect": "Allow", // ë²„í‚·ì— ëŒ€í•œ ëª…ë ¹ì„ í—ˆë½(allow)í•˜ê±°ë‚˜ ê±°ë¶€(deny). íŠ¹ì • ì‚¬ìš©ìì— ëŒ€í•´ ëª…ë ¹ì„ ì œí•œí•˜ê±°ë‚˜, í—ˆìš©í•˜ëŠ” ì‹ìœ¼ë¡œ ì‚¬ìš©
            "Principal": {"AWS": "arn:aws:iam::spark323:user/spark"}, // Bucket Policyì˜ ì ìš©ëŒ€ìƒ (spark323 ì•„ì´ë””ì˜ ìœ ì €ì— ëŒ€í•´ì„œ)
            "Action": [ // Bucket Policyì—ì„œ í—ˆìš©í•œ Action
                "s3:GetObject", // ê°ì²´ ê°€ì ¸ì˜¤ëŠ” í–‰ë™
                "s3:GetBucketLocation", // ë²„ì¼“ ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ëŠ” í–‰ë™
                "s3:ListBucket", // ë²„ì¼“ ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ëŠ” í–‰ë™
            ],
            "Resource": "arn:aws:s3:::bucketname/*", // ëŒ€ìƒì´ ëŒ€ëŠ” Bucketì— ëŒ€í•œ ëª…ì„¸
            "Condition": { // ì–´ë–¤ ì¡°ê±´ í•˜ì—
                "NotIpAddress": { // ì´ IPë¹„í—ˆìš©
                    "aws:SourceIp": "1.1.1.1/32"
                },
                "IpAddress": { // ì´ IPí—ˆìš©
                    "aws:SourceIp": [
                        "192.168.1.1",
                        "192.168.1.2/32",
                    ]
                }
            }
        }
    ]
}

```

# ì ‘ê·¼ê¶Œí•œ í…ŒìŠ¤íŠ¸
- https://dbkorea.s3.us-west-1.amazonaws.com/departments.csv

![image](https://user-images.githubusercontent.com/102650331/179356358-2ba1e1ca-85a3-4773-85ad-3a5609d8dbbf.png)

- ì•„ì§ í¼ë¸”ë¦­ìœ¼ë¡œ ì„¤ì •ë˜ì§€ ì•Šì•˜ë‹¤ëŠ” ëœ»ì´ë©° ì™¸ë¶€ì—ì„œ ì ‘ê·¼í•  ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸
- ë”°ë¼ì„œ ì™¸ë¶€ì—ì„œ í•´ë‹¹ ë²„í‚·ì— ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ í•˜ê¸° ìœ„í•´ì„œëŠ” ë²„í‚· ì •ì±…ì„ ìˆ˜ì •í•´ì•¼ í•œë‹¤.

# ë²„í‚· ì •ì±… ì„¤ì •í•˜ê¸°
![image](https://user-images.githubusercontent.com/102650331/179356581-957ad7cc-e33e-4f72-b35e-6762c24383d5.png)


# S3 ë²„í‚·ì— ìˆëŠ” ë°ì´í„°ì— ëŒ€í•œ ë³´ì•ˆì˜ í•„ìš”ì„±ì— ëŒ€í•´ì„œ ëŒ€ë‹¤ìˆ˜ì˜ ì‚¬ìš©ìëŠ” ì¸ì§€í•˜ê³  ìˆë‹¤.
## ë³´ì•ˆ ì ìš©ì´ ì–´ë ¤ìš´ ì´ìœ ?
- AWS security modelì˜ ë³µì¡ì„±ê³¼ ì´í•´í•˜ê¸° ì–´ë µë‹¤.
- ë°°í¬ í™˜ê²½ì˜ ë¹ ë¥¸ ë³€í™”
- í´ë¼ìš°ë“œ ê¸°ë°˜ì˜ ì„œë¹„ìŠ¤ì˜ í™˜ê²½ì„¤ì •ì€ APIë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„¤ì •í•˜ëŠ” ë°©ì‹
- Service Control
- Identity and Access Management
- Resource
- Boundary
- Session

## AWS Policy Evaluation Logic
![image](https://user-images.githubusercontent.com/102650331/179383499-0880c933-bd7a-4fab-99b6-045579083a5f.png)

# How to create a secure S3 bucket policy
## Context
![image](https://user-images.githubusercontent.com/102650331/179383594-f77aded4-a72a-4667-9872-28fce5ba936e.png)

## sensitive-app-data's S3 bucket policy
- Allow Administration
- Allow Reads
- Allow Writes
- Deny Actions by Unidentified Principals
- Deny Unencrypted Transport or Storage

## ì •ì±… ì„¤ì • ë°©ë²•
### Step 1: Identify who needs access
- ë²„ì¼“ ì ‘ê·¼ ëŒ€ìƒ ì •ì˜
- ë²„ì¼“ ì ‘ê·¼ ê¶Œí•œ ì •ì˜
- ci user needs administration capabilities to deploy application updates
- admin role needs administration capabilities to fix urgent problems
- app role needs read and write data capabilities for the application to function
- cust-service role needs to read data capabilities to investigate problems
- ìœ„ì˜ ìš”êµ¬ì‚¬í•­ì„ ëª¨ë‘ ìˆ˜ìš©í•  AWS accountëŠ” 111 ì´ë‹¤.

### Step 2: Create policy document
```javascript
//empty policy document
{
    "Version": "2012-10-17",
    "Statement": [
    ]
}

// ì ‘ê·¼ ê¶Œí•œì— ëŒ€í•œ ì„¤ì •ì€ Statement ë°°ì—´ì— ì¶”ê°€í•´ì„œ ê´€ë¦¬í•œë‹¤.

```

### Step 3: Deny everyone who should not have access
```javascript
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "DenyEveryoneElse",
            "Effect": "Deny",
            "Action": "s3:*",
            "Resource": [
                "arn:aws:s3:::sensitive-app-data",
                "arn:aws:s3:::sensitive-app-data/*"
            ],
            "Principal": {
                "AWS": "111"
            },
            "Condition": {
                "ArnNotEquals": [
                    "aws:PrincipalArn": [
                        "arn:aws:iam::111:role/admin",
                        "arn:aws:iam::111:role/app",
                        "arn:aws:iam::111:user/ci",
                        "arn:aws:iam::111:role/cust-service"
                    ],
                ],
            },
        }
    ]
}

```

### Step 4: Allow Intended Access â€“ Administer, Read, Write
```javascript
{
    "Sid": "Allow<CapabilityName>",
    "Effect": "Allow",
    "Action": [
        "s3:<CapabilityAction1>",
        "s3:<CapabilityAction2>",
        "s3:<CapabilityAction3>",
    ],
    "Resource": [
        "arn:aws:s3:::sensitive-app-data",
        "arn:aws:s3:::sensitive-app-data/*"
    ],
    "Principal": {
        "AWS": "*"
    },
    "Condition": {
        "ArnEquals": {
            "aws:PrincipalArn": [
                "arn:aws:iam::111:<Identity1>",
                "arn:aws:iam::111:<Identity2>"
            ],
        }
    }
},

```

### Allow Administration
```javascript
{
    "Sid": "AllowRestrictedAdministerResource",
    "Effect": "Allow",
    "Action": [
        "s3:PutReplicationConfiguration",
        "s3:PutObjectVersionAcl",
        "s3:PutObjectRetention",
        "s3:PutObjectLegalHold",
        "s3:PutObjectAcl",
        "s3:PutMetricsConfiguration",
        "s3:PutLifecycleConfiguration",
        "s3:PutInventoryConfiguration",
        "s3:PutEncryptionConfiguration",
        "s3:PutBucketWebsite",
        "s3:PutBucketVersioning",
        "s3:PutBucketTagging",
        "s3:PutBucketRequestPayment",
        "s3:PutBucketPublicAccessBlock",
        "s3:PutBucketPolicy",
        "s3:PutBucketObjectLockConfiguration",
        "s3:PutBucketNotification",
        "s3:PutBucketLogging",
        "s3:PutBucketCORS",
        "s3:PutBucketAcl",
        "s3:PutAnalyticsConfiguration",
        "s3:PutAccelerateConfiguration",
        "s3:DeleteBucketWebsite",
        "s3:DeleteBucketPolicy",
        "s3:BypassGovernanceRetention"
    ],
    "Resource": [
        "arn:aws:s3:::sensitive-app-data/*",
        "arn:aws:s3:::sensitive-app-data"
    ],
    "Principal": {
        "AWS": "*"
    },
    "Condition": {
        "ArnEquals": {
            "aws:PrincipalArn": [
                "arn:aws:iam::111:user/ci",
                "arn:aws:iam::111:role/admin"
            ]
        }
    }
}

```

### Allow Read
```javascript
{
    "Sid": "AllowRestrictedReadData",
    "Effect": "Allow",
    "Action": [
        "s3:ListBucket",
        "s3:GetObject"
    ],
    "Resource": [
        "arn:aws:s3:::sensitive-app-data/*",
        "arn:aws:s3:::sensitive-app-data"
    ],
    "Principal": {
        "AWS": "*"
    },
    "Condition": {
        "ArnEquals": {
            "aws:PrincipalArn": [
                "arn:aws:iam::111:role/app",
                "arn:aws:iam::111:role/cust-service"
            ]
        }
    }
},

```

### Allow Write
```javascript
{
    "Sid": "AllowRestrictedWriteData",
    "Effect": "Allow",
    "Action": [
        "s3:PutObject",
        "s3:AbortMultipartUpload"
    ],
    "Resource": [
        "arn:aws:s3:::sensitive-app-data/*",
        "arn:aws:s3:::sensitive-app-data"
    ],
    "Principal": {
        "AWS": "*"
    },
    "Condition": {
        "ArnEquals": {
            "aws:PrincipalArn": [
            "arn:aws:iam::111:role/app"
            ]
        }
    }
}

```

### Deny Unencrypted Transport or Storage
```javascript
{
    "Sid": "DenyInsecureCommunications",
    "Effect": "Deny",
    "Action": "s3:*",
    "Resource": [
        "arn:aws:s3:::sensitive-app-data/*",
        "arn:aws:s3:::sensitive-app-data"
    ],
    "Principal": {
        "AWS": "*"
    },
    "Condition": {
        "Bool": {
            "aws:SecureTransport": "false"
        }
    }
}

```

### ìµœì¢…
```javascript
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowRestrictedAdministerResource",
            "Effect": "Allow",
            "Action": [
                "s3:PutReplicationConfiguration",
                "s3:PutObjectVersionAcl",
                "s3:PutObjectRetention",
                "s3:PutObjectLegalHold",
                "s3:PutObjectAcl",
                "s3:PutMetricsConfiguration",
                "s3:PutLifecycleConfiguration",
                "s3:PutInventoryConfiguration",
                "s3:PutEncryptionConfiguration",
                "s3:PutBucketWebsite",
                "s3:PutBucketVersioning",
                "s3:PutBucketTagging",
                "s3:PutBucketRequestPayment",
                "s3:PutBucketPublicAccessBlock",
                "s3:PutBucketPolicy",
                "s3:PutBucketObjectLockConfiguration",
                "s3:PutBucketNotification",
                "s3:PutBucketLogging",
                "s3:PutBucketCORS",
                "s3:PutBucketAcl",
                "s3:PutAnalyticsConfiguration",
                "s3:PutAccelerateConfiguration",
                "s3:DeleteBucketWebsite",
                "s3:DeleteBucketPolicy",
                "s3:BypassGovernanceRetention"
            ],
            "Resource": [
                "arn:aws:s3:::sensitive-app-data/*",
                "arn:aws:s3:::sensitive-app-data"
            ],
            "Principal": {
                "AWS": "*"
            },
            "Condition": {
                "ArnEquals": {
                    "aws:PrincipalArn": [
                    "arn:aws:iam::111:user/ci",
                    "arn:aws:iam::111:role/admin"
                    ]
                }
            }
        },
        {
            "Sid": "AllowRestrictedReadData",
            "Effect": "Allow",
            "Action": [
                "s3:ListMultipartUploadParts",
                "s3:ListBucketVersions",
                "s3:ListBucketMultipartUploads",
                "s3:ListBucket",
                "s3:GetObjectVersionTorrent",
                "s3:GetObjectVersionTagging",
                "s3:GetObjectVersionForReplication",
                "s3:GetObjectVersionAcl",
                "s3:GetObjectVersion",
                "s3:GetObjectTorrent",
                "s3:GetObjectTagging",
                "s3:GetObjectRetention",
                "s3:GetObjectLegalHold",
                "s3:GetObjectAcl",
                "s3:GetObject",
                "s3:GetMetricsConfiguration",
                "s3:GetLifecycleConfiguration",
                "s3:GetInventoryConfiguration",
                "s3:GetEncryptionConfiguration",
                "s3:GetBucketWebsite",
                "s3:GetBucketVersioning",
                "s3:GetBucketTagging",
                "s3:GetBucketRequestPayment",
                "s3:GetBucketPublicAccessBlock",
                "s3:GetBucketPolicyStatus",
                "s3:GetBucketPolicy",
                "s3:GetBucketObjectLockConfiguration",
                "s3:GetBucketNotification",
                "s3:GetBucketLogging",
                "s3:GetBucketLocation",
                "s3:GetBucketCORS",
                "s3:GetBucketAcl"
            ],
            "Resource": [
                "arn:aws:s3:::sensitive-app-data/*",
                "arn:aws:s3:::sensitive-app-data"
            ],
            "Principal": {
                "AWS": "*"
            },
            "Condition": {
                "ArnEquals": {
                    "aws:PrincipalArn": [
                        "arn:aws:iam::111:role/cust-service",
                        "arn:aws:iam::111:role/app"
                    ]
                }
            }
        },
        {
            "Sid": "AllowRestrictedWriteData",
            "Effect": "Allow",
            "Action": [
                "s3:RestoreObject",
                "s3:ReplicateTags",
                "s3:ReplicateObject",
                "s3:ReplicateDelete",
                "s3:PutObjectVersionTagging",
                "s3:PutObjectTagging",
                "s3:PutObject",
                "s3:PutBucketTagging",
                "s3:AbortMultipartUpload"
            ],
            "Resource": [
                "arn:aws:s3:::sensitive-app-data/*",
                "arn:aws:s3:::sensitive-app-data"
            ],
            "Principal": {
                "AWS": "*"
            },
            "Condition": {
                "ArnEquals": {
                    "aws:PrincipalArn": "arn:aws:iam::111:role/app"
                }
            }
        },
        {
            "Sid": "AllowRestrictedDeleteData",
            "Effect": "Allow",
            "Action": [
                "s3:DeleteObjectVersionTagging",
                "s3:DeleteObjectVersion",
                "s3:DeleteObjectTagging",
                "s3:DeleteObject"
            ],
            "Resource": "arn:aws:s3:::sensitive-app-data/*",
            "Principal": {
                "AWS": "*"
            },
            "Condition": {
                "ArnEquals": {
                    "aws:PrincipalArn": []
                }
            }
        },
        {
            "Sid": "AllowRestrictedCustomActions",
            "Effect": "Allow",
            "Action": "s3:GetAnalyticsConfiguration",
            "Resource": [
                "arn:aws:s3:::sensitive-app-data/*",
                "arn:aws:s3:::sensitive-app-data"
            ],
            "Principal": {
                "AWS": "*"
            },
            "Condition": {
                "ArnEquals": {
                    "aws:PrincipalArn": []
                }
            }
        },
        {
            "Sid": "DenyEveryoneElse",
            "Effect": "Deny",
            "Action": "s3:*",
            "Resource": [
                "arn:aws:s3:::sensitive-app-data/*",
                "arn:aws:s3:::sensitive-app-data"
            ],
            "Principal": {
                "AWS": "139710491120"
            },
            "Condition": {
                "ArnNotEquals": {
                    "aws:PrincipalArn": [
                        "arn:aws:iam::111:user/ci",
                        "arn:aws:iam::111:role/cust-service",
                        "arn:aws:iam::111:role/app",
                        "arn:aws:iam::111:role/admin"
                    ]
                }
            }
        },
        {
            "Sid": "DenyInsecureCommunications",
            "Effect": "Deny",
            "Action": "s3:*",
            "Resource": [
                "arn:aws:s3:::sensitive-app-data/*",
                "arn:aws:s3:::sensitive-app-data"
            ],
            "Principal": {
                "AWS": "*"
            },
            "Condition": {
                "Bool": {
                    "aws:SecureTransport": "false"
                }
            }
        },
        {
            "Sid": "DenyUnencryptedStorage",
            "Effect": "Deny",
            "Action": "s3:PutObject",
            "Resource": "arn:aws:s3:::sensitive-app-data/*",
            "Principal": {
                "AWS": "*"
            },
            "Condition": {
                "Null": {
                    "s3:x-amz-server-side-encryption": "true"
                }
            }
        },
        {
            "Sid": "DenyStorageWithoutKMSEncryption",
            "Effect": "Deny",
            "Action": "s3:PutObject",
            "Resource": "arn:aws:s3:::sensitive-app-data/*",
            "Principal": {
                "AWS": "*"
            },
            "Condition": {
                "StringNotEquals": {
                    "s3:x-amz-server-side-encryption": "aws:kms"
                }
            }
        }
    ]
}

```


# ì°¸ì¡°
- https://inpa.tistory.com/entry/AWS-ğŸ“š-S3-ë²„í‚·-ìƒì„±-ì‚¬ìš©ë²•-ì‹¤ì „-êµ¬ì¶•
- https://honeywater97.tistory.com/139
- https://24hours-beginner.tistory.com/151
- https://www.k9security.io/docs/how-to-create-a-secure-s3-bucket-policy/
- 
